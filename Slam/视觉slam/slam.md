# 视觉 SLAM

## 什么是 SLAM

SLAM(Simultaneous Localization and Mapping) 是实时定位与地图构建：

指搭载特定传感器的主体，在没有环境先验信息的情况下，在运动过程中建立环境模型，同时估计自己的运动。

目的是解决 `定位` 和 `地图构建` 问题



#### 单目相机

记录三维空间的投影；

静态下无法判断景深，动态中可以通过 “近处物体移动快，远处物体移动慢” 来推测物体的远景；

动态评估得到的环境信息的 `尺度` 是不确定的，根本原因是无法获得 `深度` 信息；



#### 双目和深度相机

记录三维空间的投影，并且获得 `深度` 信息；

双目相机的两个相机之间的距离称为“基线”，通过基线和大量计算来估计每个像素的空间位置，和人眼类似；双目相机得到的 `深度` 信息不太可靠。基线越长，能测到的距离越远；

深度相机（RGB-D）相机，增加红外结构光或 Tof 直接测得深度信息。



#### 经典视觉 SLAM 框架

1. 传感器信息读取：相机图像信息读取和预处理。可能还有码盘，惯性传感器等信息的读取
2. 前端视觉里程计：估算相邻图像间相机的运动，以及局部地图的样子。
3. 后端（非线性）优化：后端接收不同时刻视觉里程计测量的相机位姿，以及回环检测信息进行优化，得到全局一致的轨迹和地图。
4. 回环检测：判断机器人是否到达过先前的位置。如果检测到回环，会把信息提供给后端处理。
5. 建图：根据估计轨迹，建立与任务要求对应的地图。



#### 视觉里程计

视觉里程计关心相邻图像间的相机运动，最简单的就是两张图像间的运动关系。为了定量估计相机运动，必须先了解相机与空间点的几何关系。

视觉里程计通过相邻图像估计相机运动并恢复场景的空间结构。

把相邻时刻的运动“串”起来，就构成了机器人的运动轨迹，从而解决了定位问题。再根据每个时刻的相机位置，计算各像素对应的空间点位置，就得到了地图。但仅通过视觉里程计估计轨迹，将出现累积漂移。因为视觉里程计只通过过去短时间内的图像估计造成的。每个时刻的误差会被传递到下一个时刻，导致一段时间后轨迹不再精确。

为解决漂移问题，需要`后端优化` 和`回环检测`



#### 后端优化

后端优化主要处理 SLAM 的噪声问题。要考虑如何从带有噪声的传感器信息数据中估计整个系统的状态，以及这个状态估计的不确定性有多大，也称为最大后验概率估计，这个状态包括轨迹和地图。

视觉里程计也称为前端。前端给后端提供待优化的数据，及数据的初值。后端面对的是数据，并不需要关心数据来自什么传感器。在视觉里程计中，前端和计算机视觉研究更加相关，比如图像的特征提取和匹配等，后端则主要过滤与非线性优化算法。

SLAM 问题的本质是对运动主体和周围环境空间不确定性的估计。为解决 SLAM 问题需要状态估计理论，把定位和建图的不确定性表达出来，然后采用滤波器或非线性优化，估计状态的均值和不确定性（方差）。



#### 回环检测

也称为闭环检测，主要解决位置估计随时间漂移的问题。假如检测到机器“回到了某个位置”，但位置估计值却没有在那个位置，那么机器需要把位置估计值“拉”到那个位置，就可以消除漂移了。

回环检测与“定位”和“建图”二者密切相关。为实现回环检测，需要让机器“识别到过的场景”的能力。可以通过判断图像相似性来完成回环检测，是一种计算图像数据相似性的算法。

经过回环检测后，我们会把 A 和 B 是同一个点的信息告诉后端优化算法，后端根据信息把轨迹和地图调整到符合回环检测结果的样子。



#### 建图

度量地图：

度量地图强调精确表示地图中物体位置关系。分有稀疏和稠密两类。稀疏地图进行了一定程度的抽象，并不需要表达所有物体，可以选择一部分有意义的东西作为`路标` ，非路标部分可以直接忽略。定位时用稀疏路标地图就够了，而导航则往往需要用稠密地图，稠密地图通常按照某种分辨率，有许多小块组成，一个小块一般由占据、空闲、未知三个状态。

拓扑地图：

拓扑地图强调地图元素间的关系，拓扑地图由节点和边组成，只考虑节点间的连通性，例如关心A，B是连通的，而不考虑如何从A到B。放松了地图对精确位置的需要，去掉地图细节，是更为紧凑的表达方式。

然而拓扑地图仍待研究。



#### SLAM 问题的数学表达

假设机器人再未知环境中运动，在离散时刻 t = 1, 2, ... k 时候采集传感器数据。用 x 表示机器位置，于是各个时刻的位置表示为 x1, x2, ... x_k，它们构成了轨迹。假设地图由 n 个路标组成，用 y1, y2, ... y_n 表示。

在上面的设定中，“机器人在环境中运动”，由如下两件事情描述：

1. 什么是运动 ？我们要考察机从 k-1 到 k 时刻，机器的位置 x 是如何变化的。
2. 什么是观测 ？假设机器在 k 时刻于 x_k 出探测到某个路标 y_j，我们要考察如何用数学语言来描述。

先看运动，机器一般通过码盘，惯性传感器等测量自身运动，机器在 “前进 1 米”，“左转 90 °”，“刹车”等运动，可以用下面的抽象函数描述：

`x_k = f(x_k-1, u_k, w_k)`

`u_k`是运动传感器的数据，`w_k` 是该过程的噪声，`x_k-1` 是上个时刻的位置，`x_k`是当前时刻的位置

噪声的存在使得模型变成了随机模型。例如“前进 1 米”的指令，实际可能只前进了 0.9 米，也可能是 1.1 米。噪声是随机的。

于运动方程相对应的是观测方程。机器在 x_k 位置看到了路标 y_j 时，产生了一个观测数据 z_k,j。用下面的抽象函数表示：

`z_k,j = h(y_j, x_k, v_k,j)`

`v_k,j` 是观测噪声，`y_j` 观测目标，`x_k` 是观测位置，`z_k,j`是观测结果

假设机器用二维激光传感器观测，那么可以得到路标和机器的距离 r 和夹角 θ。记路标为 y_j = [y1, y2]^T _k，机器位姿为 x_k = [x1, x2]^T _k，观测数据为 z_k,j = [r_k,j, θ\_k,j]^T，那么观测方程为：

![](观测方策的数学模型.jpg)

SLAM 的过程可以总结为：

x_k = f(x_k-1, u_k, w_k)，k = 1, ...k

z_k,j = h(y_j, x_k, v_k,j)，(k, j) ∈ O  (O 是一个集合，记录了观察到路标)

方程描述了已知运动测量读数 u，传感器数据 z 时，求解定位问题（估计 x）和建图问题（估计 y），我们把 SLAM 问题建模成状态估计问题：如何通过带有噪声的测量读数，估计内部，隐藏的状态变量。

状态估计问题的求解，与两方程的具体形式，以及噪声服从哪种分布有关。按运动和观测方程是否为线性，噪声是否服从高斯分布进行分类，分为`线性/非线性` 和`高斯/非高斯`系统。其中`线性高斯系统`最简单，它的无偏最优估计可以由卡尔曼滤波器（KF）给出。而复杂的`非线性非高斯系统`可以用扩展卡尔曼滤波器（EKF）和非线性优化两大类方法求解。知道 21 世纪早期，EKF 会在工作点把系统线性化，以预测-更新两大步骤进行求解。为了克服 EKF 缺点，例如线性化误差和噪声高斯分布假设，人们开始用粒子滤波器等其他滤波器，乃至使用非线性优化的方法。主流视觉 SLAM 使用图优化为代表的优化技术进行状态估计。**一般认为优化技术已经明显优于滤波器技术**。



## 三维空间刚体运动

线性代数库`Eigen` 提供矩阵计算，其中 `Geometry` 模块提供四元素等描述刚体运动的结构。



#### 旋转矩阵

三维空间中的基向量为[e1, e2, e3]，任意向量 a 表示为：

a = [{e1, e2, e3}] [{a1} {a2} {3}] = a1e1 + a2e2 + a3e3 （这里 {} 表示占矩阵一行） 

向量的点乘（内积）: a · b

几何意义：向量a 在向量b 方向上投影与|b|的乘积，反应两个向量的相似度，结果越大越相似。

向量的叉乘（外积）: a x b

几何意义：如果向量a 和向量b 构成平行四边形，那么外积的模长与该四边形的面积相等。

把 a 写成矩阵，事实上是`反对称矩阵`，将 `^` 记作反对称符号。a x b 写为矩阵和向量的乘法 a ^ b



#### 坐标系间的欧氏变换

两个坐标系间的运动由一个旋转加一个平移组成，这种运动称为刚体运动。刚体运动中物体的位姿变换过程称为欧氏变换。由旋转和平移组成。

某个单位正交基(e1, e2, e3)经过旋转为(e1', e2', e3')，对于同一个向量a（没有因为旋转发生运动），它在两个坐标系下坐标为[{a1}, {a2}, {a3}] 和 [{a1'}, {a2'}, {a3'}]（这里 {} 表示占矩阵一行），那么有：

```
[{e1, e2, e3}] [{a1}, {a2}, {a3}] = [{e1', e2', e3'}]  [{a1'}, {a2'}, {a3'}]
```

左右两边同左乘 [{e1^T}, {e2^T}, {e3^T}] 得到

```
[{a1}, {a2}, {a3}] = R a'
```

R 描述了坐标系的旋转，称为旋转矩阵

旋转矩阵的行列式为 1，表示为 det(R) = 1

行列式的几何意义是变换后的新基的面积或体积的伸缩率。行列式为 1 表示经过旋转变换后，两个坐标系没有发生伸缩变换。



设坐标系1，坐标系2，向量a 在两个坐标系中坐标为a1，a2，欧式变换的旋转用旋转矩阵R表示，平移用平移向量t表示，那么：

```
a1 = R12 a2 + t12
```

R12 表示从坐标系2 到坐标系1 的变换，t12 实际表示的是坐标系1 原点指向坐标系2 原点，在坐标系1 中取的向量



#### 变换矩阵和齐次坐标

假设进行两次变换：b = R1 a + t1, c = R2 b + t2，从 a 到 c 的变换为：c = R2 (R1 a + t1) + t2

引入齐次坐标和变换矩阵：[{a'} {1}] = [{R, t} {0^T, 1}] [{a} {1}] = T [{a} {1}]

这是一个数学技巧，在三维向量末尾添加 1 ，将其变为四维向量，称为齐次坐标。在四维向量中，我们把旋转和平移写在一个矩阵里，使得整体关系变为线性关系，矩阵 T 称为变换矩阵。

用 a' 变 a 的齐次坐标，那么 a 到 c 变换可以写为：b' = T1 a', c' = T2 b'  ---> c' = T2 T1 a'

变换矩阵 T 的左上角为旋转矩阵，右上角为平移向量，左下角为 0，右下角为 1。这种矩阵又称为特殊欧氏群。



#### 学会使用 Eigen 库



#### 旋转向量和欧拉角

6 个自由度：3 个维度的旋转和平移

任意旋转都可以由一个旋转轴和一个旋转角来描述。

一个向量的方向与旋转轴一致，长度等于旋转角，这样的向量称为旋转向量（或角轴），只需要一个三维向量就可以描述旋转。

对于一个变换矩阵，可以用一个旋转向量和一个平移向量来描述，此时该变量维数是六维。



用 R 表示旋转，旋转轴上单位向量为 n ，角度 θ，从旋转向量到旋转矩阵的转换过程由 `罗德里格斯公式` 表明：

![](罗德里格斯公式.jpg)



欧拉角将一个三维空间的旋转分解为 3 个不同旋转轴的旋转的顺序组合。

z 轴旋转，得到偏航角（yaw）；y 轴旋转，得到俯仰角（pitch）；x 轴旋转，得到翻滚角（roll）；

欧拉角的万向锁问题：当俯仰角为 ±90°时候，第一次旋转和第三次旋转都使用同一个轴，使得系统丢失一个自由度（从 3 次旋转变为 2 次旋转）。**任何用 3 个实数来表达三维旋转都会遇到这个奇异性问题**。（当旋转角度大于 360° 时候，旋转向量也会发生奇异性问题）因此欧拉角并不适合用于插值，迭代计算，但是适合人机交互。

![](欧拉角.jpg)



#### 四元数

三维向量描述三维旋转都带有奇异性，就像用经纬度描述地球表面位置，当纬度±90° 时候，经度会失去意义一样。

四元数是一种扩展复数，紧凑且没有奇异性。

二维平面的旋转可以用**<u>单位复数</u>**来描述，三维空间的旋转可以用**<u>单位四元数</u>**来描述。

一个四元数有一个实部和三个虚部：q = q0 + q1i + q2j + q3k；其中

1. i^2 = j^2 = k ^2 = -1；
2. ij = k, ji = -k；
3. jk = i, kj = -i；
4. ki = j, ik = -j；

把 i j k 看作三个坐标轴，那么它们与自身的乘法同复数一样，互相间的乘法同外积一样。

有时也用一个标量和一个向量来表达四元数：

q = [{s}, {v}]，s = q0 ∈ R，v = [{q1} {q2} {q3}] ∈ R^3，s 称为四元数实部，v 称为虚部。

四元数的运算：

1、加减法；2、乘法；3、模长；4、共轭；5、逆；6、数乘；



四元数表示旋转：

假设空间三维点 p = [x, y, z] ，一个单位四元数 q 指定旋转。旋转后变为 p'。

把三维空间点用一个虚四元数表示 p = [0, x, y, z]^T = [0, v]^T，把四元数 3 个虚部和空间 3 个轴对应。

那么旋转后 p' = q p q^(-1)，取出 p' 的虚部即得到旋转后的点坐标

任意单位四元数描述了一个旋转，该旋转也可以用旋转矩阵和旋转向量表示。

单位四元数到旋转矩阵和旋转向量的转换公式：略



#### *相似，仿射，射影变换

![](常见变换性质对比.jpg)



#### 可视化演示

通过 pangolin 库来观察三维空间变换。



## 李群和李代数

三维旋转矩阵构成特殊正交群 SO(3)，变换矩阵构成特殊欧氏群 SE(3)：

![](旋转正交群，旋转欧氏群.jpg)



旋转矩阵，变换矩阵没有（良好地）定义加法，减法，除法运算，只定义好了乘法运算，且可以求逆。像这样只有一种（良好）定义的运算的集合，我们称为群。

群是一种集合加一种运算的代数结构。把集合记作 A，把运算记作 ·，群可以记作 G = （A, ·）。群要求该运算满足：

1. 封闭性：a1 · a2 = a3，(a1 a2 a3 ∈ A)；
2. 结合律：(a1 · a2) · a3 = a1 · (a2 · a3)，(a1 a2 a3 ∈ A)；
3. 幺元：存在 a0，对于任意 a，有 a0 · a = a · a0 = a
4. 逆：任意 a，存在 a^(-1)，有 a · a^(-1) = a0



李群是指具有连续（光滑）性质的群。



























































